---
title: "Building Tidy Data"
author: "Ian Dinwoodie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo=TRUE)
```

# Overview

This notebook serves as reference for the tidying procedures used to prepare the
study data for analysis.

# Building the Data Frame

## Loading the Data Into Memory

We start the tidying process from the available processed data set since it has
been structured and has been through a minimal, but necessary, manual data
cleaning process.

```{r}
df <- read.csv('../data/data/processed/processed.csv', header=TRUE,
               skipNul=TRUE, na.strings=c("","NA"))
stopifnot(identical(dim(df)+0, c(5057, 490)))
str(df, list.len=12)
```

## Applying Readable Column Names

A list of improved column names focused on readability has been provided in the
reference directory. Let's load and apply these updated names to our data frame.

```{r}
colnames(df) <- readr::read_lines('../references/readable-column-names.txt')
str(df, list.len=12)
```

## Drop All Non-Applicable Entries

We can drop all entries where:

* The treatment response phase (i.e., phase 2) is incomplete.
* Fear/anxiety is not indicated.

```{r}
df <- df %>%
  filter(phase_2_complete == 2) %>%
  filter(has_exhibited_fear_anxiety == 1)
stopifnot(identical(dim(df)+0, c(1308, 490)))
```

## Dropping Unnecessary Columns

A list of the necessary columns for tidying the data has been provided in the
reference directory (`references/columns-for-tidying.csv`). Let's load this file
and drop any unmentioned columns.

```{r}
df <- df %>% select(
  readr::read_lines('../references/columns-for-tidying.txt'))
stopifnot(identical(dim(df)+0, c(1308, 269)))
```

# Adjusting Data Types

We use the following sections to adjust field types in the data frame.

## Numeric

```{r, warning=FALSE}
df <- df %>%
  mutate_at(vars(matches('_(wks|mos|yrs|dose|freq)$')), funs(as.numeric(.))) %>%
  mutate_at(vars(matches('_time_to_improve$')), funs(as.numeric(.)))
df$weight <- as.numeric(df$weight)

df %>% select(matches('_(wks|mos|yrs)$')) %>% str(list.len=5)
```

### Unifying Timescales

```{r}
df <- df %>%
  mutate(
    cur_age_in_mos=ifelse(
      is.na(cur_age_in_mos), cur_age_in_yrs*12, cur_age_in_mos),
    cur_age_in_yrs=NULL) %>%
  mutate(
    acq_age_in_mos=ifelse(
      is.na(acq_age_in_mos), acq_age_in_yrs*12, acq_age_in_mos),
    acq_age_in_yrs=NULL) %>% 
  mutate(
    neuter_age_in_mos=ifelse(
      is.na(neuter_age_in_mos), neuter_age_in_yrs*12, neuter_age_in_mos),
    neuter_age_in_yrs=NULL)
```

## Logical

For some questions where a binary response was desired an additional "I don't
know" response was allowed. We make a first pass through the binary fields to
convert these values to NA. We then make a second pass to convert the fields to
type logical.

```{r}
df <- df %>%
  mutate_at(vars(matches('^(is|has)_')), funs(replace(., . == 2, NA))) %>%
  mutate_at(vars(matches('^(is|has)_')), funs(as.logical(.))) %>%
  mutate(is_male=(sex==1), sex=NULL)

df %>% select(matches('^(is|has)_')) %>% str(list.len=5)
```

## Factor

```{r}
df <- df %>%
  mutate_at(vars(matches('_rating$')), funs(as.factor(.))) %>%
  mutate_at(vars(matches('_units$')), funs(as.factor(.)))
df$purebred_akc_breed <- as.factor(df$purebred_akc_breed)
df$acquisition_source <- as.factor(df$acquisition_source)
df$prof_with_best_results <- as.factor(df$prof_with_best_results)
df$non_improve_ultimate_outcome <- as.factor(df$non_improve_ultimate_outcome)
df$owner_id <- as.factor(df$owner_id)

str(df, list.len=5)
```

# Drop Unused Factor Levels

Sub-setting the data frame to only the entries for dogs with fear/anxiety may
result in unused factor levels. These unused levels can be dropped.

```{r}
df[] <- lapply(df, function(x) if(is.factor(x)) factor(x) else x)
```

# Final Summary

Verify that the tidy data set contains only the expected columns.

```{r}
expected_cols <- readr::read_lines('../references/expected-tidy-columns.txt')
actual_cols <- colnames(df)
set_diff <-setdiff(expected_cols, actual_cols)
stopifnot(length(set_diff) == 0)
set_diff = setdiff(actual_cols, expected_cols)
stopifnot(length(set_diff) == 0)
rm(set_diff, expected_cols, actual_cols)
```

Take a last look at the data before saving it to disk.

```{r}
dim(df)

old_max_print <- getOption("max.print")
options(max.print=.Machine$integer.max)
summary(df)
options(max.print=old_max_print)
rm(old_max_print)
```

# Saving the Tidy Data

Save the data to a file in the data directory using RDS format so that the data
types are stored and the resulting file is compressed.

```{r}
#write.table(colnames(df), '../references/expected-tidy-columns.txt',
#            row.names=FALSE, col.names=FALSE)
dir.create(path='../build/', showWarnings=FALSE)
saveRDS(df, '../build/tidy.Rds')
```
