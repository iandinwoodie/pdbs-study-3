---
title: "Building Tidy Data"
author: "Ian Dinwoodie"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggpubr)
knitr::opts_chunk$set(echo=TRUE)
```

# Overview

This notebook serves as reference for the tidying procedures used to prepare the
study data for analysis.

# Loading the Data

We start the tidying process from the manually cleaned data set
(`data/manually-cleaned.csv`) since it is structured and coded appropriately.
Explanations for the various stages of the study data are available in the data
directory README file (`data/README.md`).

```{r}
# TODO: Replace "manually-cleaned-mock.csv" with "manually-cleaned.csv" when it
# is available.
df <- read.csv('../data/manually-cleaned-mock.csv', header=TRUE, skipNul=TRUE)
stopifnot(identical(dim(df)+0, c(2318, 484)))
str(df, list.len=10)
```

Our starting data set is 2318 rows (completed dog entries) by 484 columns (data
fields per dog).

# Isolate Minimal Data Set

Our first priority is to isolate the minimal data set for this study.

## Drop Unnecessary Columns

We start by dropping all columns that are unnecessary from the start.

```{r}
drop_patterns <- c(
  '^record_id$', '^dog_name$', '^q([0-9][1,3,5-9]|[1-9][0-9])_.*$',
  '^q02_main_([3-9]|[0-9]{2})$', '^q02_score$', '^q04_count$',
  paste0('^(aggression|repbeh|soiling|marking|excited|barking|jumping|mounting',
         '|feces|destructive|disgust|escape)_.*$')
)
df <- df[, -grep(paste(drop_patterns, collapse='|'), names(df))]
stopifnot(identical(dim(df)+0, c(2318, 275)))
dim(df)
```

The number of columns is reduced by about 43% and the number of rows remains the
same (as expected).

## Isolate Fearful and/or Anxious Dogs

For this study we are investigating fear and anxiety, therefore we only need to
retain records relevant to that goal.

```{r}
# Field "q02_main_2" is the binary indicator for fear/anxiety in the data set.
df <- df %>%
  filter(q02_main_2 == 1) %>%
  select(-one_of('q02_main_2'))
stopifnot(identical(dim(df)+0, c(1305, 274)))
str(df, list.len=10)
```

We see that there are entries for 1305 fearful and/or anxious dogs in the data
set and the column count has decremented to 274 as a result of dropping the
fear/anxiety indicator.

# Final Summary

Take a last look at the data before saving it to disk.

```{r}
dim(df)
summary(df)
```

# Saving the Tidy Data

Save the data to a file in RDS format so that the data types are saved and so
that the output is compressed.

```{r}
saveRDS(df, '../data/tidy.Rds')
```
